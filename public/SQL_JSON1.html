<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clase VB.NET para Manejo de Campos JSON en SQL Server</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 20px; }
        h1, h2, h3 { color: #333; }
        pre { background: #f4f4f4; padding: 10px; border: 1px solid #ddd; overflow-x: auto; }
        code { font-family: Consolas, monospace; }
        .copyable { margin-bottom: 20px; }
        .copyable button { margin-top: 5px; cursor: pointer; }
    </style>
    <script>
        function copyToClipboard(id) {
            const text = document.getElementById(id).innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('Copiado al portapapeles');
            }).catch(err => {
                console.error('Error al copiar: ', err);
            });
        }
    </script>
</head>
<body>
    <h1>Clase VB.NET para Manejo de Campos JSON en SQL Server</h1>
    <p>Esta página proporciona una implementación completa de una clase en VB.NET para manejar un campo JSON almacenado en un NVARCHAR(MAX) en SQL Server. El JSON representa atributos variables como listas de valores (ej: "Animal:Perro" o "Color:Verde, Rojo"). La clase soporta guardar, recuperar y modificar los datos. Incluye consideraciones para SQL Server 2017 y 2022, aunque el soporte JSON es similar en ambas versiones (usando funciones como OPENJSON, JSON_VALUE, etc., disponibles desde SQL Server 2016). Para 2017, usamos consultas básicas; para 2022, podemos aprovechar mejoras menores en rendimiento, pero las consultas son idénticas aquí por simplicidad.</p>
    
    <p>La estructura interna usa un <code>Dictionary(Of String, List(Of String))</code> para representar los atributos y sus valores múltiples.</p>
    
    <h2>Implementación de la Clase en VB.NET</h2>
    <p>A continuación, el código completo de la clase <code>JsonAttributeHandler</code>. Usa Newtonsoft.Json para serialización/deserialización (asegúrate de agregar la referencia via NuGet: <code>Install-Package Newtonsoft.Json</code>). Para interactuar con SQL Server, usa ADO.NET (requiere <code>Imports System.Data.SqlClient</code>).</p>
    
    <div class="copyable">
        <pre id="class-code"><code>Imports System.Data.SqlClient
Imports Newtonsoft.Json
Imports System.Collections.Generic

Public Class JsonAttributeHandler
    Private _attributes As New Dictionary(Of String, List(Of String))
    Private _connectionString As String
    Private _sqlVersion As String  ' "2017" o "2022"

    ''' &lt;summary&gt;
    ''' Constructor.
    ''' &lt;/summary&gt;
    ''' &lt;param name="connectionString"&gt;Cadena de conexión a SQL Server.&lt;/param&gt;
    ''' &lt;param name="sqlVersion"&gt;Versión de SQL Server: "2017" o "2022".&lt;/param&gt;
    Public Sub New(connectionString As String, sqlVersion As String)
        _connectionString = connectionString
        If sqlVersion &lt;&gt; "2017" AndAlso sqlVersion &lt;&gt; "2022" Then
            Throw New ArgumentException("Versión de SQL Server no soportada. Usa '2017' o '2022'.")
        End If
        _sqlVersion = sqlVersion
    End Sub

    ''' &lt;summary&gt;
    ''' Agrega o actualiza un atributo con sus valores.
    ''' &lt;/summary&gt;
    Public Sub AddOrUpdateAttribute(attributeName As String, values As List(Of String))
        If _attributes.ContainsKey(attributeName) Then
            _attributes(attributeName) = values
        Else
            _attributes.Add(attributeName, values)
        End If
    End Sub

    ''' &lt;summary&gt;
    ''' Guarda los atributos como JSON en la base de datos.
    ''' &lt;/summary&gt;
    ''' &lt;param name="tableName"&gt;Nombre de la tabla.&lt;/param&gt;
    ''' &lt;param name="idColumn"&gt;Columna ID para identificar el registro.&lt;/param&gt;
    ''' &lt;param name="idValue"&gt;Valor del ID.&lt;/param&gt;
    ''' &lt;param name="jsonColumn"&gt;Nombre de la columna JSON (NVARCHAR(MAX)).&lt;/param&gt;
    Public Sub SaveToDatabase(tableName As String, idColumn As String, idValue As Integer, jsonColumn As String)
        Dim json As String = JsonConvert.SerializeObject(_attributes)
        Using conn As New SqlConnection(_connectionString)
            conn.Open()
            Dim cmd As New SqlCommand($"UPDATE {tableName} SET {jsonColumn} = @json WHERE {idColumn} = @id", conn)
            cmd.Parameters.AddWithValue("@json", json)
            cmd.Parameters.AddWithValue("@id", idValue)
            cmd.ExecuteNonQuery()
        End Using
    End Sub

    ''' &lt;summary&gt;
    ''' Recupera el JSON directamente de la base de datos (SELECT directo).
    ''' &lt;/summary&gt;
    ''' &lt;returns&gt;El JSON como string.&lt;/returns&gt;
    Public Function GetJsonDirect(tableName As String, idColumn As String, idValue As Integer, jsonColumn As String) As String
        Using conn As New SqlConnection(_connectionString)
            conn.Open()
            Dim cmd As New SqlCommand($"SELECT {jsonColumn} FROM {tableName} WHERE {idColumn} = @id", conn)
            cmd.Parameters.AddWithValue("@id", idValue)
            Return CStr(cmd.ExecuteScalar())
        End Using
    End Function

    ''' &lt;summary&gt;
    ''' Carga los atributos desde el JSON de la base de datos a la clase para modificación.
    ''' &lt;/summary&gt;
    ''' &lt;returns&gt;El Dictionary cargado.&lt;/returns&gt;
    Public Function LoadFromDatabase(tableName As String, idColumn As String, idValue As Integer, jsonColumn As String) As Dictionary(Of String, List(Of String))
        Dim json As String = GetJsonDirect(tableName, idColumn, idValue, jsonColumn)
        If Not String.IsNullOrEmpty(json) Then
            _attributes = JsonConvert.DeserializeObject(Of Dictionary(Of String, List(Of String)))(json)
            Return _attributes
        Else
            Return New Dictionary(Of String, List(Of String))
        End If
    End Function

    ''' &lt;summary&gt;
    ''' Consulta SQL para extraer valores específicos usando funciones JSON (compatible con 2017 y 2022).
    ''' Ejemplo: Extrae valores de un atributo dado.
    ''' &lt;/summary&gt;
    ''' &lt;param name="attributeName"&gt;Nombre del atributo.&lt;/param&gt;
    ''' &lt;returns&gt;Lista de valores.&lt;/returns&gt;
    Public Function QueryAttributeValues(tableName As String, idColumn As String, idValue As Integer, jsonColumn As String, attributeName As String) As List(Of String)
        Dim values As New List(Of String)
        ' Consulta base compatible con ambas versiones (OPENJSON disponible desde 2016)
        Dim query As String = $"
            SELECT [value]
            FROM {tableName}
            CROSS APPLY OPENJSON({jsonColumn}, '$.{attributeName}')
            WHERE {idColumn} = @id"
        
        ' Para 2022, podría usarse JSON_PATH o mejoras, pero mantenemos igual por simplicidad.
        
        Using conn As New SqlConnection(_connectionString)
            conn.Open()
            Dim cmd As New SqlCommand(query, conn)
            cmd.Parameters.AddWithValue("@id", idValue)
            Using reader As SqlDataReader = cmd.ExecuteReader()
                While reader.Read()
                    values.Add(reader.GetString(0))
                End While
            End Using
        End Using
        Return values
    End Function
End Class</code></pre>
        <button onclick="copyToClipboard('class-code')">Copiar Código de la Clase</button>
    </div>

    <h2>Ejemplos de Datos</h2>
    <p>Aquí hay ejemplos de datos JSON que se almacenarían en el campo NVARCHAR(MAX):</p>
    <div class="copyable">
        <pre id="data-example1"><code>{
  "Animal": ["Perro"],
  "Color": ["Verde", "Rojo"]
}</code></pre>
        <button onclick="copyToClipboard('data-example1')">Copiar Ejemplo 1</button>
    </div>
    <div class="copyable">
        <pre id="data-example2"><code>{
  "Forma": ["Cuadrado"],
  "Tamaño": ["Grande", "Mediano", "Pequeño"],
  "Material": ["Madera"]
}</code></pre>
        <button onclick="copyToClipboard('data-example2')">Copiar Ejemplo 2</button>
    </div>

    <h2>Ejemplos de Uso de la Clase</h2>
    <p>Ejemplo de uso en un programa VB.NET. Asume una tabla <code>MiTabla</code> con columnas <code>ID (INT)</code> y <code>AtributosJson (NVARCHAR(MAX))</code>.</p>
    <div class="copyable">
        <pre id="usage-example"><code>Dim connectionString As String = "Server=myServer;Database=myDB;Trusted_Connection=True;"
Dim handler As New JsonAttributeHandler(connectionString, "2022")  ' O "2017"

' Agregar atributos
handler.AddOrUpdateAttribute("Animal", New List(Of String) From {"Perro"})
handler.AddOrUpdateAttribute("Color", New List(Of String) From {"Verde", "Rojo"})

' Guardar en DB (para ID=1)
handler.SaveToDatabase("MiTabla", "ID", 1, "AtributosJson")

' Recuperar JSON directo
Dim jsonDirect As String = handler.GetJsonDirect("MiTabla", "ID", 1, "AtributosJson")
Console.WriteLine(jsonDirect)

' Cargar para modificar
Dim attrs As Dictionary(Of String, List(Of String)) = handler.LoadFromDatabase("MiTabla", "ID", 1, "AtributosJson")
attrs("Color").Add("Azul")  ' Modificar
handler.AddOrUpdateAttribute("Color", attrs("Color"))  ' Actualizar en clase
handler.SaveToDatabase("MiTabla", "ID", 1, "AtributosJson")  ' Guardar cambios

' Query valores de un atributo
Dim colors As List(Of String) = handler.QueryAttributeValues("MiTabla", "ID", 1, "AtributosJson", "Color")
For Each color In colors
    Console.WriteLine(color)
Next</code></pre>
        <button onclick="copyToClipboard('usage-example')">Copiar Ejemplo de Uso</button>
    </div>

    <h2>Consultas SQL Directas</h2>
    <p>Para SQL Server 2017/2022 (idénticas):</p>
    <div class="copyable">
        <pre id="sql-example"><code>-- Recuperar JSON completo
SELECT AtributosJson FROM MiTabla WHERE ID = 1;

-- Extraer valores de 'Color'
SELECT [value]
FROM MiTabla
CROSS APPLY OPENJSON(AtributosJson, '$.Color')
WHERE ID = 1;</code></pre>
        <button onclick="copyToClipboard('sql-example')">Copiar Consultas SQL</button>
    </div>
</body>
</html>
