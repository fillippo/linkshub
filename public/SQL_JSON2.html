<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VB.NET y SQL Server: Generador de Scripts para JSON (Versión Corregida)</title>
<style>
body {
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
line-height: 1.6;
color: #333;
max-width: 900px;
margin: 20px auto;
padding: 0 15px;
background-color: #f9f9f9;
}
h1, h2, h3 {
color: #005A9E;
border-bottom: 2px solid #005A9E;
padding-bottom: 5px;
}
.code-container {
position: relative;
margin-bottom: 20px;
}
.code-header {
display: flex;
justify-content: space-between;
align-items: center;
background-color: #e9ecef;
padding: 8px 15px;
border: 1px solid #dee2e6;
border-bottom: none;
border-top-left-radius: 5px;
border-top-right-radius: 5px;
}
.code-header-title {
font-weight: bold;
color: #495057;
font-family: "Consolas", monospace;
}
.copy-button {
background-color: #007bff;
color: white;
border: none;
padding: 6px 12px;
border-radius: 4px;
cursor: pointer;
font-size: 0.9em;
transition: background-color 0.2s;
}
.copy-button:hover {
background-color: #0056b3;
}
.copy-button.copied {
background-color: #28a745;
}
pre {
background-color: #2d2d2d;
color: #f1f1f1;
padding: 15px;
overflow-x: auto;
border: 1px solid #dee2e6;
margin: 0;
border-radius: 5px;
border-top-left-radius: 0;
border-top-right-radius: 0;
}
code {
font-family: "Consolas", "Monaco", "Lucida Console", monospace;
font-size: 0.95em;
}
.note {
background-color: #e7f3fe;
border-left: 6px solid #2196F3;
padding: 15px;
margin: 20px 0;
}
</style>
</head>
<body>
code
Code
<h1>Manejo Avanzado de JSON en SQL Server con Generador de Scripts en VB.NET (Versión Corregida)</h1>
<p>
    Esta guía proporciona una solución completa que no solo gestiona atributos dinámicos en una clase de VB.NET, sino que también genera los fragmentos de código SQL necesarios para realizar operaciones de lectura (SELECT) y escritura (INSERT/UPDATE) de forma externa.
</p>

<h2>Paso 1: Configuración de la Base de Datos (SQL Server 2017)</h2>
<p>
    La estructura de la base de datos no cambia.
</p>
<div class="code-container">
    <div class="code-header">
        <span class="code-header-title">Script T-SQL: Creación de la tabla</span>
        <button class="copy-button" onclick="copyCode(this)">Copiar</button>
    </div>
    <pre><code class="language-sql">-- Crear una tabla de ejemplo (Ej: Productos)
CREATE TABLE Productos (
ID INT PRIMARY KEY IDENTITY(1,1),
NombreProducto VARCHAR(255) NOT NULL,
Atributos NVARCHAR(MAX)
);
GO
-- Añadir una restricción para asegurar que los datos en 'Atributos' sean siempre un JSON válido
ALTER TABLE Productos
ADD CONSTRAINT CHK_Productos_Atributos_IsJSON CHECK (ISJSON(Atributos) > 0);
GO
</code></pre>
</div>
code
Code
<h2>Paso 2: La Clase de Gestión de Atributos en VB.NET (Versión Final)</h2>
<p>
    A la clase se le han añadido dos nuevas funciones: <code style="color:red; font-weight:bold;">GenerarValorSqlParaUpdate</code> y <code style="color:red; font-weight:bold;">GenerarClausulaSqlSelect</code>.
</p>
<div class="note">
    <strong>Dependencia Requerida:</strong> Se sigue utilizando <strong>Newtonsoft.Json</strong>. (<code>Install-Package Newtonsoft.Json</code>)
</div>
<div class="code-container">
    <div class="code-header">
        <span class="code-header-title">Clase VB.NET: GestionAtributos.vb (Final)</span>
        <button class="copy-button" onclick="copyCode(this)">Copiar</button>
    </div>
    <pre><code class="language-vb">' Imports necesarios
Imports Newtonsoft.Json
Imports System.Collections.Generic
Imports System.Text
Public Class GestionAtributos
code
Code
Public Property Atributos As Dictionary(Of String, List(Of String))

Public Sub New()
    Atributos = New Dictionary(Of String, List(Of String))()
End Sub

' --- Métodos de Manipulación de Datos ---
Public Sub EstablecerAtributo(ByVal nombre As String, ByVal valor As String)
    Atributos(nombre) = New List(Of String)({valor})
End Sub

Public Sub EstablecerAtributos(ByVal nombre As String, ByVal valores As List(Of String))
    Atributos(nombre) = valores
End Sub

Public Sub AgregarValorAtributo(ByVal nombre As String, ByVal valorAAgregar As String)
    If Atributos.ContainsKey(nombre) Then
        If Not Atributos(nombre).Contains(valorAAgregar) Then
            Atributos(nombre).Add(valorAAgregar)
        End If
    Else
        Atributos.Add(nombre, New List(Of String)({valorAAgregar}))
    End If
End Sub

Public Sub SuprimirValorAtributo(ByVal nombre As String, ByVal valorASuprimir As String)
    If Atributos.ContainsKey(nombre) Then
        Atributos(nombre).Remove(valorASuprimir)
        If Atributos(nombre).Count = 0 Then
            Atributos.Remove(nombre)
        End If
    End If
End Sub

Public Sub SuprimirAtributoCompleto(ByVal nombre As String)
    Atributos.Remove(nombre)
End Sub

' --- Serialización ---
Public Function ToJson() As String
    Return JsonConvert.SerializeObject(Atributos, Formatting.None)
End Function

Public Shared Function FromJson(ByVal jsonString As String) As GestionAtributos
    Dim gestor = New GestionAtributos()
    If Not String.IsNullOrEmpty(jsonString) Then
        gestor.Atributos = JsonConvert.DeserializeObject(Of Dictionary(Of String, List(Of String)))(jsonString)
    End If
    Return gestor
End Function

' --- (NUEVO) Generadores de SQL ---

''' &lt;summary&gt;
''' Genera el valor de texto literal que se debe usar en una consulta SQL para insertar o actualizar el campo JSON.
''' Se encarga de formatear el JSON y añadir las comillas simples necesarias.
''' &lt;/summary&gt;
''' &lt;returns&gt;Una cadena con el formato N'{ "Atributo": ["Valor"] }'&lt;/returns&gt;
Public Function GenerarValorSqlParaUpdate() As String
    If Atributos Is Nothing OrElse Atributos.Count = 0 Then
        Return "NULL"
    End If
    ' La N inicial es importante para cadenas Unicode (NVARCHAR)
    ' Se reemplaza cualquier comilla simple por dos para escaparla en SQL.
    Return "N'" & Me.ToJson().Replace("'", "''") & "'"
End Function

''' &lt;summary&gt;
''' Genera la cláusula SELECT para "desnormalizar" los atributos JSON en columnas planas.
''' Se basa en la estructura actual del objeto para definir qué columnas generar.
''' &lt;/summary&gt;
''' &lt;param name="aliasTabla"&gt;El alias de la tabla en la consulta SQL (ej. "p").&lt;/param&gt;
''' &lt;param name="nombreCampoJson"&gt;El nombre del campo que contiene el JSON (ej. "Atributos").&lt;/param&gt;
''' &lt;returns&gt;Una cadena como ", JSON_VALUE(p.Atributos, '$.Color') AS Color1, ..."&lt;/returns&gt;
Public Function GenerarClausulaSqlSelect(ByVal aliasTabla As String, ByVal nombreCampoJson As String) As String
    If Atributos Is Nothing OrElse Atributos.Count = 0 Then Return String.Empty

    Dim sb As New StringBuilder()

    For Each kvp As KeyValuePair(Of String, List(Of String)) In Atributos
        Dim nombreAtributo = kvp.Key
        Dim valores = kvp.Value
        
        ' Si la lista de valores está vacía o es nula, asumimos que queremos al menos una columna.
        Dim maxValores = If(valores IsNot Nothing AndAlso valores.Count > 0, valores.Count, 1)

        For i As Integer = 0 To maxValores - 1
            ' Añadimos la coma inicial para cada cláusula
            sb.Append(", ")
            ' Usamos el alias de la tabla y el nombre del campo
            sb.Append($"JSON_VALUE({aliasTabla}.{nombreCampoJson}, '$.{nombreAtributo}[{i}]')")
            ' Creamos el alias de la columna, ej. Color1, Color2
            sb.Append($" AS {nombreAtributo}{i + 1}")
        Next
    Next

    Return sb.ToString()
End Function
End Class
</code></pre>
</div>
code
Code
<h2>Paso 3: Ejemplo de Uso de los Generadores de SQL</h2>
<p>
    Este módulo demuestra cómo utilizar las nuevas funciones para construir consultas SQL dinámicamente.
</p>

<div class="note">
    <strong>Concepto Clave para SELECT:</strong> La función <code>GenerarClausulaSqlSelect</code> se basa en la estructura del objeto que la llama. Debes crear un objeto "plantilla" que defina la máxima cantidad de valores que esperas recuperar por cada atributo. Por ejemplo, si sabes que un producto puede tener hasta 3 colores, tu objeto plantilla debe tener una lista con 3 elementos para el atributo "Color".
</div>

<div class="code-container">
    <div class="code-header">
        <span class="code-header-title">Ejemplo de implementación: GeneracionSql.vb</span>
        <button class="copy-button" onclick="copyCode(this)">Copiar</button>
    </div>
    <pre><code class="language-vb">Public Module GeneracionSql
Public Sub Main()

    ' --- EJEMPLO 1: GENERAR CLÁUSULA SELECT ---
    Console.WriteLine("--- 1. Generando Cláusula SELECT ---")

    ' Creamos un objeto "plantilla" para definir la estructura que queremos consultar.
    ' Queremos obtener hasta 2 colores y 1 talla.
    Dim plantillaSelect As New GestionAtributos()
    plantillaSelect.EstablecerAtributos("Color", New List(Of String)({"val1", "val2"})) ' 2 valores
    plantillaSelect.EstablecerAtributo("Talla", "val1") ' 1 valor

    ' Generamos la cláusula SQL usando el alias 'p' para la tabla y 'Atributos' para el campo.
    Dim clausulaSelect As String = plantillaSelect.GenerarClausulaSqlSelect("p", "Atributos")

    ' Construimos la consulta completa
    Dim consultaSelectCompleta As String = "SELECT p.ID, p.NombreProducto" & clausulaSelect & " FROM Productos p WHERE p.ID = 1;"

    Console.WriteLine("Cláusula generada:")
    Console.WriteLine(clausulaSelect)
    Console.WriteLine()
    Console.WriteLine("Consulta SELECT completa:")
    Console.WriteLine(consultaSelectCompleta)
    Console.WriteLine(New String("-", 50))


    ' --- EJEMPLO 2: GENERAR VALOR PARA UPDATE O INSERT ---
    Console.WriteLine("--- 2. Generando Valor para UPDATE/INSERT ---")

    ' Creamos un objeto con los datos específicos que queremos guardar.
    Dim datosGuardar As New GestionAtributos()
    datosGuardar.AgregarValorAtributo("Color", "Verde")
    datosGuardar.AgregarValorAtributo("Color", "Azul")
    datosGuardar.EstablecerAtributo("Material", "Algodón")
    datosGuardar.EstablecerAtributo("Proveedor", "O'Malley's Fabrics") ' Incluye una comilla simple

    ' Generamos el valor SQL literal.
    Dim valorSql As String = datosGuardar.GenerarValorSqlParaUpdate()

    ' Construimos la consulta completa de actualización.
    Dim consultaUpdateCompleta As String = "UPDATE Productos SET Atributos = " & valorSql & " WHERE ID = 2;"

    Console.WriteLine("Valor SQL generado:")
    Console.WriteLine(valorSql)
    Console.WriteLine()
    Console.WriteLine("Consulta UPDATE completa:")
    Console.WriteLine(consultaUpdateCompleta)
    Console.WriteLine(New String("-", 50))

    Console.ReadLine()
End Sub
End Module
</code></pre>
</div>
code
Code
<h3>Resultado Esperado en la Consola (Corregido)</h3>
<p>La ejecución del código anterior producirá la siguiente salida, mostrando los scripts SQL correctos y listos para ser usados.</p>
<div class="code-container">
    <div class="code-header">
        <span class="code-header-title">Salida de la Consola</span>
        <button class="copy-button" onclick="copyCode(this)">Copiar</button>
    </div>
    <pre><code class="language-text">--- 1. Generando Cláusula SELECT ---
Cláusula generada:
, JSON_VALUE(p.Atributos, '
.
C
o
l
o
r
′
)
A
S
C
o
l
o
r
1
,
J
S
O
N
V
A
L
U
E
(
p
.
A
t
r
i
b
u
t
o
s
,
′
.Color 
′
 )ASColor1,JSON 
V
​
 ALUE(p.Atributos, 
′
 
.Color') AS Color2, JSON_VALUE(p.Atributos, '$.Talla') AS Talla1
Consulta SELECT completa:
SELECT p.ID, p.NombreProducto, JSON_VALUE(p.Atributos, '
.
C
o
l
o
r
′
)
A
S
C
o
l
o
r
1
,
J
S
O
N
V
A
L
U
E
(
p
.
A
t
r
i
b
u
t
o
s
,
′
.Color 
′
 )ASColor1,JSON 
V
​
 ALUE(p.Atributos, 
′
 
.Color') AS Color2, JSON_VALUE(p.Atributos, '$.Talla') AS Talla1 FROM Productos p WHERE p.ID = 1;
--- 2. Generando Valor para UPDATE/INSERT ---
Valor SQL generado:
N'{"Color":["Verde","Azul"],"Material":["Algodón"],"Proveedor":["O''Malley''s Fabrics"]}'
Consulta UPDATE completa:
UPDATE Productos SET Atributos = N'{"Color":["Verde","Azul"],"Material":["Algodón"],"Proveedor":["O''Malley''s Fabrics"]}' WHERE ID = 2;
</code></pre>
</div>
code
Code
<script>
    function copyCode(buttonElement) {
        const pre = buttonElement.closest('.code-container').querySelector('pre');
        const code = pre.querySelector('code');
        const textToCopy = code.innerText;

        navigator.clipboard.writeText(textToCopy).then(() => {
            buttonElement.textContent = '¡Copiado!';
            buttonElement.classList.add('copied');
            setTimeout(() => {
                buttonElement.textContent = 'Copiar';
                buttonElement.classList.remove('copied');
            }, 2000);
        }).catch(err => {
            console.error('Error al copiar el texto: ', err);
            buttonElement.textContent = 'Error';
        });
    }
</script>
</body>
</html>
